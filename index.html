<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÎÑ§Ïò® Îã∑Ï†Ä - Îû≠ÌÇπ Î∞∞ÌãÄ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            color: white;
            user-select: none;
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 10;
        }

        .hud-text {
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        #shield-status {
            color: #00ffff;
            font-size: 1.2rem;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        #mode-indicator {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        #menu-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }

        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
            display: none !important; 
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 0px;
            background: linear-gradient(to right, #00f260, #0575e6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(5, 117, 230, 0.5);
            text-align: center;
        }

        p.sub-title {
            color: #ccc;
            margin-bottom: 20px;
            font-size: 1.2rem;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: center;
        }

        #nickname-input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: 2px solid #00f260;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border-radius: 30px;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            width: 200px;
            outline: none;
            transition: box-shadow 0.3s;
        }

        #nickname-input:focus {
            box-shadow: 0 0 15px rgba(0, 242, 96, 0.5);
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            background: transparent;
            color: #fff;
            border: 2px solid #00f260;
            border-radius: 30px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(0, 242, 96, 0.3);
            margin-top: 10px;
        }

        .btn:hover {
            background: #00f260;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 242, 96, 0.8);
            transform: scale(1.05);
        }

        .btn:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .score-big {
            font-size: 3rem;
            color: #fff;
            margin: 10px 0;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        /* Îû≠ÌÇπ Ïä§ÌÉÄÏùº */
        .ranking-box {
            margin-top: 20px;
            background: rgba(0, 20, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00f260;
            width: 80%;
            max-width: 400px;
            text-align: center;
            max-height: 250px;
            overflow-y: auto;
        }

        .ranking-title {
            color: #00f260;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 242, 96, 0.3);
            padding-bottom: 5px;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 1rem;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #ccc;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-1 { color: #ffd700; font-weight: bold; text-shadow: 0 0 5px #ffd700; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        .loading-text {
            color: #888;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .score-big { font-size: 2rem; }
            .ranking-box { width: 90%; }
        }
    </style>
</head>
<body>

    <!-- UI Î†àÏù¥Ïñ¥ -->
    <div id="ui-layer">
        <div class="hud-text">TIME: <span id="scoreDisplay">0.00</span>s</div>
        <div id="shield-status">SHIELD ACTIVE!</div>
        <div id="mode-indicator">LOCAL MODE</div>
    </div>

    <!-- ÏãúÏûë Î©îÎâ¥ -->
    <div id="menu-screen">
        <h1>NEON DODGER</h1>
        <p class="sub-title">Ranking Battle</p>
        
        <div class="input-group">
            <input type="text" id="nickname-input" placeholder="NICKNAME" maxlength="10">
        </div>

        <button class="btn" id="startBtn">GAME START</button>
        
        <!-- Îû≠ÌÇπ Î∞ïÏä§ -->
        <div class="ranking-box">
            <div class="ranking-title" id="ranking-title-text">üèÜ RANKING</div>
            <ul id="menu-ranking-list" class="ranking-list">
                <li class="loading-text">Loading...</li>
            </ul>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ïò§Î≤Ñ ÌôîÎ©¥ -->
    <div id="game-over-screen" class="hidden">
        <h1 style="color: #ff4b4b; -webkit-text-fill-color: #ff4b4b; background: none;">GAME OVER</h1>
        <div class="score-big">Í∏∞Î°ù: <span id="finalScore">0.00</span>s</div>
        <div id="upload-status" style="color: #888; margin-bottom: 10px;">Í∏∞Î°ù Ï†ÄÏû• Ï§ë...</div>
        <button class="btn" id="restartBtn">Îã§Ïãú ÌïòÍ∏∞</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        // =================================================================================
        // [ÏÑ§Ï†ï Íµ¨Ïó≠] ÍπÉÌóàÎ∏å ÌéòÏù¥ÏßÄ Îì± Ïô∏Î∂Ä Î∞∞Ìè¨ Ïãú ÏïÑÎûò Í∞íÏùÑ Ï±ÑÏõåÎÑ£ÏúºÏÑ∏Ïöî.
        // Firebase ÏΩòÏÜî -> ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï -> ÎÇ¥ Ïï± -> SDK ÏÑ§Ï†ï Î∞è Íµ¨ÏÑ± -> firebaseConfig Í∞ùÏ≤¥ Î≥µÏÇ¨
        // ÌÇ§ Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Î°úÏª¨ Î™®Îìú(ÎÇ¥ Ïª¥Ìì®ÌÑ∞ÏóêÎßå Ï†ÄÏû•)Î°ú ÎèôÏûëÌï©ÎãàÎã§.
        // =================================================================================
        const USER_FIREBASE_CONFIG = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // =================================================================================

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        let db = null;
        let auth = null;
        let currentUser = null;
        let isGlobalMode = false;
        let appId = 'neon-dodger-default';

        // UI Elements
        const startBtn = document.getElementById('startBtn');
        const nicknameInput = document.getElementById('nickname-input');
        const rankingList = document.getElementById('menu-ranking-list');
        const uploadStatus = document.getElementById('upload-status');
        const restartBtn = document.getElementById('restartBtn');
        const modeIndicator = document.getElementById('mode-indicator');
        const rankingTitleText = document.getElementById('ranking-title-text');

        // --- System Initialization ---
        async function initSystem() {
            // 1. Check for Chat Environment Config (Priority 1)
            let config = null;
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    config = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : appId;
                    console.log("Environment: Interactive Chat (Global Mode)");
                } catch(e) { console.error("Config Parse Error", e); }
            } 
            
            // 2. Check for User Config (Priority 2)
            if (!config && USER_FIREBASE_CONFIG.apiKey) {
                config = USER_FIREBASE_CONFIG;
                console.log("Environment: User Config (Global Mode)");
            }

            // 3. Initialize Firebase if config exists
            if (config) {
                try {
                    const app = initializeApp(config);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    // Auth Logic
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    isGlobalMode = true;
                    modeIndicator.innerText = "GLOBAL RANKING MODE";
                    rankingTitleText.innerText = "üèÜ GLOBAL RANKING";
                } catch (error) {
                    console.error("Firebase Init Failed:", error);
                    fallbackToLocal();
                }
            } else {
                // 4. Fallback to Local Storage
                fallbackToLocal();
            }

            // Load Rankings
            fetchRankings();
        }

        function fallbackToLocal() {
            isGlobalMode = false;
            modeIndicator.innerText = "LOCAL RANKING MODE";
            rankingTitleText.innerText = "üèÜ LOCAL RANKING";
            console.log("Environment: Local Storage Mode");
            
            // Generate basic local data if empty
            if (!localStorage.getItem('neonDodgerScores')) {
                const defaults = [
                    { name: 'NEON', score: 30.00 },
                    { name: 'TEST', score: 15.00 },
                    { name: 'USER', score: 5.00 }
                ];
                localStorage.setItem('neonDodgerScores', JSON.stringify(defaults));
            }
        }

        // --- Data Logic (Hybrid) ---
        async function fetchRankings() {
            rankingList.innerHTML = '<li class="loading-text">Loading...</li>';
            let scores = [];

            if (isGlobalMode && db) {
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
                    querySnapshot.forEach((doc) => scores.push(doc.data()));
                } catch (error) {
                    console.error("Fetch Error:", error);
                    rankingList.innerHTML = '<li class="loading-text">Server Error. Try Local.</li>';
                    return;
                }
            } else {
                // Local Mode
                const saved = localStorage.getItem('neonDodgerScores');
                scores = saved ? JSON.parse(saved) : [];
            }

            // Sort & Render
            scores.sort((a, b) => b.score - a.score);
            const topScores = scores.slice(0, 10);

            if (topScores.length === 0) {
                rankingList.innerHTML = '<li class="loading-text">No records yet.</li>';
            } else {
                rankingList.innerHTML = topScores.map((s, i) => {
                    let rankClass = '';
                    if (i === 0) rankClass = 'rank-1';
                    else if (i === 1) rankClass = 'rank-2';
                    else if (i === 2) rankClass = 'rank-3';
                    
                    return `
                        <li class="ranking-item">
                            <span class="${rankClass}">${i + 1}. ${escapeHtml(s.name)}</span>
                            <span class="${rankClass}">${parseFloat(s.score).toFixed(2)}s</span>
                        </li>
                    `;
                }).join('');
            }
        }

        async function saveScore(score) {
            const name = nicknameInput.value.trim() || "UNKNOWN";
            uploadStatus.innerText = "Í∏∞Î°ù Ï†ÄÏû• Ï§ë...";
            
            if (isGlobalMode && db && auth && auth.currentUser) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                        userId: auth.currentUser.uid,
                        name: name,
                        score: score,
                        timestamp: Date.now()
                    });
                    uploadStatus.innerText = "Í∏ÄÎ°úÎ≤å Îû≠ÌÇπ Îì±Î°ù ÏôÑÎ£å!";
                    uploadStatus.style.color = "#00f260";
                } catch (error) {
                    uploadStatus.innerText = "ÏóÖÎ°úÎìú Ïã§Ìå® (Î°úÏª¨Ïóê Ï†ÄÏû•)";
                    saveLocal(name, score);
                }
            } else {
                saveLocal(name, score);
                uploadStatus.innerText = "Î°úÏª¨ Îû≠ÌÇπ Îì±Î°ù ÏôÑÎ£å!";
                uploadStatus.style.color = "#00f260";
            }
            fetchRankings();
        }

        function saveLocal(name, score) {
            const saved = localStorage.getItem('neonDodgerScores');
            let scores = saved ? JSON.parse(saved) : [];
            scores.push({ name: name, score: score, timestamp: Date.now() });
            localStorage.setItem('neonDodgerScores', JSON.stringify(scores));
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // --- Game Engine ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const shieldStatus = document.getElementById('shield-status');
        const finalScoreDisplay = document.getElementById('finalScore');
        const menuScreen = document.getElementById('menu-screen');
        const gameOverScreen = document.getElementById('game-over-screen');

        let animationId, startTime;
        let elapsedTime = 0, frames = 0, difficultyMultiplier = 0;
        let gameActive = false;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const keys = { w: false, a: false, s: false, d: false, ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false };
        window.addEventListener('keydown', (e) => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
        window.addEventListener('keyup', (e) => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });

        let touchX = null, touchY = null;
        window.addEventListener('touchstart', (e) => { touchX = e.touches[0].clientX; touchY = e.touches[0].clientY; }, {passive: false});
        window.addEventListener('touchmove', (e) => { e.preventDefault(); touchX = e.touches[0].clientX; touchY = e.touches[0].clientY; }, {passive: false});
        window.addEventListener('touchend', () => { touchX = null; touchY = null; });

        class Player {
            constructor() {
                this.radius = 15; this.x = canvas.width/2; this.y = canvas.height/2;
                this.color = '#00f260'; this.speed = 7; this.invincibleUntil = 0;
            }
            isInvincible() { return Date.now() < this.invincibleUntil; }
            activateShield() { this.invincibleUntil = Date.now() + 2000; shieldStatus.style.opacity = 1; }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = this.color; ctx.shadowBlur = 20; ctx.shadowColor = this.color; ctx.fill(); ctx.closePath(); ctx.shadowBlur=0;
                if (this.isInvincible()) {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.radius+10, 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(0, 255, 255, ${Math.random()*0.5+0.5})`;
                    ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = '#00ffff'; ctx.stroke(); ctx.closePath(); ctx.shadowBlur=0;
                } else shieldStatus.style.opacity = 0;
            }
            update() {
                let mx=0, my=0;
                if(keys.w||keys.ArrowUp) my=-this.speed; if(keys.s||keys.ArrowDown) my=this.speed;
                if(keys.a||keys.ArrowLeft) mx=-this.speed; if(keys.d||keys.ArrowRight) mx=this.speed;
                if(touchX!==null && touchY!==null) {
                    const dx=touchX-this.x, dy=touchY-this.y;
                    if(Math.hypot(dx,dy)>10) { const a=Math.atan2(dy,dx); mx=Math.cos(a)*this.speed; my=Math.sin(a)*this.speed; }
                }
                this.x+=mx; this.y+=my;
                if(this.x<this.radius) this.x=this.radius; if(this.x>canvas.width-this.radius) this.x=canvas.width-this.radius;
                if(this.y<this.radius) this.y=this.radius; if(this.y>canvas.height-this.radius) this.y=canvas.height-this.radius;
                this.draw();
            }
        }

        class Enemy {
            constructor() {
                this.radius = Math.random()*(12-5)+5;
                if(Math.random()<0.5){ this.x=Math.random()<0.5?-this.radius:canvas.width+this.radius; this.y=Math.random()*canvas.height; }
                else{ this.x=Math.random()*canvas.width; this.y=Math.random()<0.5?-this.radius:canvas.height+this.radius; }
                this.color=`hsl(${Math.random()*60+330},100%,50%)`;
                const a=Math.atan2(player.y-this.y, player.x-this.x);
                const s=(Math.random()*3+3)*(1+difficultyMultiplier*0.2);
                this.v={x:Math.cos(a)*s, y:Math.sin(a)*s};
            }
            update() {
                this.x+=this.v.x; this.y+=this.v.y;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle=this.color; ctx.shadowBlur=10; ctx.shadowColor=this.color; ctx.fill(); ctx.closePath(); ctx.shadowBlur=0;
            }
        }

        class ShieldItem {
            constructor() {
                this.radius=12; this.x=Math.random()*(canvas.width-40)+20; this.y=Math.random()*(canvas.height-40)+20;
                this.color='#00ffff'; this.pulse=0; this.createdAt=frames; this.lifeTime=600;
            }
            update() {
                this.x+=Math.sin(frames*0.05)*0.5; this.y+=Math.cos(frames*0.05)*0.5; this.pulse+=0.1;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle=this.color; ctx.shadowBlur=15+Math.sin(this.pulse)*5; ctx.shadowColor=this.color; ctx.fill();
                ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.beginPath();
                ctx.moveTo(this.x-5,this.y); ctx.lineTo(this.x+5,this.y); ctx.moveTo(this.x,this.y-5); ctx.lineTo(this.x,this.y+5);
                ctx.stroke(); ctx.closePath(); ctx.shadowBlur=0;
            }
        }

        class Particle {
            constructor(x,y,c) { this.x=x; this.y=y; this.c=c; this.r=Math.random()*3; this.v={x:(Math.random()-0.5)*8,y:(Math.random()-0.5)*8}; this.a=1; }
            update() { this.v.x*=0.96; this.v.y*=0.96; this.x+=this.v.x; this.y+=this.v.y; this.a-=0.02;
                ctx.save(); ctx.globalAlpha=this.a; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fillStyle=this.c; ctx.fill(); ctx.restore(); }
        }

        let player, enemies=[], particles=[], shields=[];

        function startGame() {
            if (!nicknameInput.value.trim()) { alert("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!"); return; }
            player = new Player(); enemies=[]; particles=[]; shields=[];
            frames=0; difficultyMultiplier=0; gameActive=true; startTime=Date.now();
            scoreDisplay.innerText="0.00"; shieldStatus.style.opacity=0;
            menuScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden');
            animate();
        }

        function animate() {
            if(!gameActive) return;
            animationId = requestAnimationFrame(animate);
            elapsedTime = (Date.now()-startTime)/1000;
            scoreDisplay.innerText = elapsedTime.toFixed(2);
            ctx.fillStyle='rgba(5,5,5,0.2)'; ctx.fillRect(0,0,canvas.width,canvas.height);

            player.update();
            shields.forEach((s,i)=>{
                s.update();
                if(Math.hypot(player.x-s.x, player.y-s.y) < s.radius+player.radius) {
                    player.activateShield(); shields.splice(i,1);
                    for(let k=0;k<8;k++) particles.push(new Particle(s.x,s.y,'#00ffff'));
                } else if(frames-s.createdAt > s.lifeTime) shields.splice(i,1);
            });
            particles.forEach((p,i)=>{ if(p.a<=0) particles.splice(i,1); else p.update(); });
            enemies.forEach((e,i)=>{
                e.update();
                if(Math.hypot(player.x-e.x, player.y-e.y) < e.radius+player.radius) {
                    if(!player.isInvincible()) endGame();
                }
                if(e.x<-100||e.x>canvas.width+100||e.y<-100||e.y>canvas.height+100) setTimeout(()=>enemies.splice(i,1),0);
            });
            let rate = Math.max(5, 40-(difficultyMultiplier*3));
            if(frames%rate===0) {
                enemies.push(new Enemy());
                if(difficultyMultiplier>=5&&Math.random()<0.5) enemies.push(new Enemy());
                if(difficultyMultiplier>=10&&Math.random()<0.3) enemies.push(new Enemy());
            }
            if(frames%600===0&&Math.random()<0.5) shields.push(new ShieldItem());
            frames++; if(frames%180===0) difficultyMultiplier++;
        }

        function endGame() {
            gameActive=false; cancelAnimationFrame(animationId);
            for(let i=0;i<20;i++) particles.push(new Particle(player.x,player.y,player.color));
            const loop=setInterval(()=>{
                ctx.fillStyle='rgba(5,5,5,0.2)'; ctx.fillRect(0,0,canvas.width,canvas.height);
                particles.forEach((p,i)=>{ if(p.a<=0) particles.splice(i,1); else p.update(); });
                enemies.forEach(e=>e.update());
                if(particles.length===0) clearInterval(loop);
            },16);
            finalScoreDisplay.innerText=elapsedTime.toFixed(2);
            saveScore(elapsedTime);
            setTimeout(()=>gameOverScreen.classList.remove('hidden'),500);
        }

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', ()=>{
            menuScreen.classList.remove('hidden'); gameOverScreen.classList.add('hidden'); fetchRankings();
        });

        // Start initialization
        initSystem();

    </script>
</body>
</html>